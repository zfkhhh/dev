mysql innodb引擎，每张表结构存.frm文件，表数据存.ibd文件

表空间分为 行、页、区、段：
1. 每条数据记录就是一行；
2. 数据库的读取是按页，一页有16KB；
3. b+树结构每层每个节点都有指向相邻节点的指针，如果用页存储就会存在大量不连续空间，所以如果数据量大，每个索引空间按区来分配；区有1MB
4. 一个表空间就是多段，包括索引段：b+树非叶子节点的区的集合；数据段：叶子节点的区的集合；回滚段：回滚数据区的集合

行结构: 记录的额外数据+真实数据
1. 额外数据包括：变长字段长度列表、null值列表、头数据；前两个是倒序存放
变长字段长度列表包含了当前记录的所有变长字段真实长度，如varchar、text等，如果小于等于255，会用1字节存储，大于会用2字节存储
null值列表包含所有可能为null的字段，值为null的字段置为1；所以字段推荐设置为not null，至少节省1字节空间（如果超过8个字段null，会创建2字节的空间等）
头数据包含是否删除标识、下条记录指针等

为什么前两个是倒叙？因为头数据包括下条记录指针，指向的下条记录额外数据与真实数据之间，这样往前读就是对应列的额外数据，往后读就是真实列

2. 真实数据包括：row id隐藏主键, trx id创建事务id, roll ptr上一版本的指针
- 如果表结构设置主键或者唯一索引列，就没有row_id；如果都没设置，会生成row_id隐藏主键
- trx id和roll ptr是必须的，是mvcc实现的基础

mvcc实现的快照读：创建read view，知道创建时活跃事务列表、最小的活跃事务id和全局事务的最大id+1；根据记录的trx id可以把记录分为三种，小于最小活跃事务id的记录是已提交数据，在最小活跃事务和最大id之间的是未提交的事务，大于最大id的是未开始的事务；那么除了自己更新的数据外，可见的数据就是已提交事务，未提交事务中不在活跃事务列表的行记录，表示已提交事务，可见

面试题：

1. MySQL 的 NULL 值会占用空间吗？

不会占用真实空间，会占额外数据的1字节空间，如果超过8个字段就再创建1字节

2. MySQL 怎么知道 varchar(n) 实际占用数据的大小？

根据额外数据中的变成字段长度列表，里面记录了行记录中变长字段实际占用的空间大小

3. varchar(n) 中 n 最大取值为多少？

除了text，blobs等大对象，其他类型行记录最大空间是65535字节（包括了额外数据，真实数据）
varchar中的n表示的是最多能存储多少字符，假设就一个varchar字段，如果字符集是ascii，就是 65535 − 2 − 1，2是变长长度，1是null值空间
如果字符集是utf8，一字符3字节，65532/3 

4. 行溢出后，MySQL 是怎么处理的？

知道一页最多16kb，varchar最大都有65535，如果行数据超过了页，
compact行格式下，会将溢出的数据放到溢出页，然后在真实数据用20字节放指向溢出页的指针
在compressed和dynamic下只会存放溢出页的指针