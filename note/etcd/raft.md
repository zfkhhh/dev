raft是分布式一致性算法，保证分布式集群的数据一致性；工作原理是在集群中选举一位leader，leader负责接收客户端请求并管理到其他服务器的日志复制

raft算法需要解决三个问题
1. 如果安全的选举一个leader
2. 如何安全的将log复制到其他节点
3. 如果安全的保证节点变更

一、 选举机制

1. 节点只有三种状态，follower, leader, candidate
2. 每个节点都有随机的选举超时时间，leader会定时给所有的节点发送心跳包（时间小于节点超时时间），表示leader还存活
3. 当节点在超时时间内没有获得leader心跳，变为candidate状态，进入预投票，给所有节点广播投票请求（预投票节点不会增加任期）
4. 投票请求包含candidate的任期序号，最新日志的任期和索引，节点收到投票请求后会比较，候选节点任期，最新日志大于等于当前节点任期、最新日志，回复同意
5. 预投票半数以上同意，再进行真正的投票，任期+1，半数以上同意就转为leader
6. 当原有leader恢复连接，会判断任期，任期小的leader转为follower
7. 选举的安全性：日志的结构包含任期，日志索引，比较时先比较任期，任期一致比较索引；保证了leader一定包含最新的提交日志

二、日志复制

1. leader收到数据变更日志，会向其他节点发送日志复制的请求，请求包含leader的任期id，前一条日志preIndex和preTerm，半数一致提交的最大日志索引commitIndex
2. 其他节点判断 leader的任期大于等于当前节点并且通过一致性校验（一致性校验：当前节点已存的日志列表包含前一条日志的preIndex和preTerm），通过就将请求中待复制的日志覆盖当前节点日志，更新commitIndex
3. 如果没通过一致性校验，返回失败，leader会将前移待复制的日志列表，直到成功日志复制到当前节点

三、节点变更

当扩缩容或者节点故障导致集群变更，无法将节点立即转换到新配置，可能出现脑裂，集群出现新配置集群的多数派和旧配置集群的多数派，就会出现多leader
解决办法： 
1. 单节点变更：集群一次只变更一个节点，新旧集群就一定不会出现多个多数派
2. 联合共识
2.1 当集群还在旧集群时，旧集群的多数派就可以达成一致
2.2 当集群出现新旧集群多数派时，集群进入联合共识，需要新旧集群多数派同时达成一致才可以做决定
2.3 当集群为新集群时，新集群多数派可以达成一致