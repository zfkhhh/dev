redis高可用的方案：主从复制、哨兵模式、redis cluster集群

一、主从复制
1. redis主从复制模式就是一主多从，主从读写分离
2. 主从复制模式的高可用需要保证主从节点的数据一致性，主从节点的数据同步分为三种
2.1 第一次同步分为三步：
2.1.1 当从节点执行replicaof命令形成了主从关系，会发送主服务器id和复制进度offset，第一次同步是为？和-1；主节点会响应自己的id和主节点数据的偏移量；接下来执行全量复制
2.1.2 主节点执行bgsave生成rdb文件，将rdb文件发给从节点，从节点会清空数据加载rdb文件，完成后响应消息给主服务器；从主节点开始生成rdb到从节点加载完rdb过程中，如果有修改操作，会记录到replication buffer中
2.1.3 主服务器接收到响应消息后将replication buffer中的修改命令发给从服务器，完成主从节点间的数据同步
2.2 完成第一次同步后，会建立tcp长连接同步消息，每次主节点修改命令会发到replication buffer中，然后异步发送消息到从节点
2.3 增量复制：当主从节点连接断开后，恢复重连，通过增量复制恢复主从数据一致性
2.3.1 增量复制的流程：恢复连接后，从节  发送自己的复制进度给主节点，主节点每次修改数据时会往一个环形队列的缓存repl_backlog_buffer中加，环形队列默认1m，数据满时会覆盖数据，所以主节点会判断从节点的偏移量是否在环形队列中，存在就将从节点偏移量到主节点间的命令发到replication buffer，发给从节点，如果不存在，就执行一次全量复制；如果是修改频繁的场景，为了减少全量复制应该调整repl_backlog_buffer的大小
3. redis判断节点是否正常，是依靠节点间的ping-pong心跳检测，如果半数节点ping一个节点没有pong响应，就认为这个节点异常，会断开与这个节点的连接；主节点每10s与从节点ping-pong检测，而从节点每秒都会上报自己的复制进度，目的就是实时检测主从网络和尽量保证自身数据的一致性
4. 如何应对主从节点数据不一致
4.1 尽量保证主从节点间的网络情况良好，保证在一个机房
4.2 因为从节点每秒同步一次，可能不符合要求，可以使用外部服务来检测主从节点间的复制进度
4.2.1 通过info replication获得主从节点复制进度，外部服务检测到主从偏移量间的差值，到达一个阈值就不然访问该从节点
5. 主从复制数据丢失：两种情况：
5.1 主从节点同步数据采用异步的方式，修改命令先存在replication buffer，再同步给从节点；如果还未来的及同步主节点宕机了，主节点的同步数据就会丢失；存在配置min-slaves-max-lag表示如果异步复制的延迟超过了该配置值，主节点就会拒绝接收所有修改，可以适量调小该配置
5.2 脑裂情况：哨兵模式下主节点宕机会将一个从节点升为主节点，如果旧主节点存在未同步的数据，再恢复后旧主节点降为从节点，会被新主节点的全量复制覆盖数据，导致数据丢失

二、哨兵模式
1. 主从复制模式对主节点异常后主节点选举没办法处理，只能通过人工干涉；redis提供了哨兵模式，用来处理主从节点故障转移
2、哨兵是运行在特殊模式下的进程，相当于是观察者节点；通常为了保证可靠性，会部署哨兵集群，通过多个哨兵一起判断节点是否异常
2. 哨兵模式主要负责：监控、选举、通知
2.1 哨兵会每隔1s会ping redis所有节点，如果没有响应就会认为该节点主观下线，会向哨兵集群的其他哨兵发送命令，其他哨兵根据与节点的网络状态，判断其是否主观下线，当判断下线的节点超过一个配置项quorum的值时，认为该节点客观下线，如果是主节点客观下线，会将一个从节点选举成主节点
2.2 选举分为哨兵选举master和从节点选举主节点
2.2.1 需要先从哨兵集群中选出一个leader来主持主节点选举：判定为客观下线的哨兵节点是候选者，发起选举给自己投票并让其他节点投票，每个节点只有一票，候选节点才可以投给自己；当投票数超过集群半数，且超过配置项quorum，就选举成了leader进行主从故障转移
2.2.2 有四步：选中合适的从节点；通知其他节点主节点信息并建立连接；通知客户端主节点变化；监控旧主节点，如果旧主节点恢复连接，降为从节点并连接主节点
2.2.2.1 选择合适的从节点：先排除异常的从节点；再排除网络状态不良好的从节点，通过一个参数主从节点网络超时时间超过10次，认为该从节点之前网络状况不好；从其他从节点中，先选优先级高的节点，再选复制进度高的节点，最后选id小的节点
2.2.2.2 其他从节点连接新主节点
2.2.2.3 哨兵集群每个哨兵节点会提供发布订阅机制，客户端会订阅到主节点的变更信息，更好主节点配置
2.2.2.4 哨兵集群会继续监控旧主节点，如果旧主节点恢复连接，降为从节点并连接主节点
2.3 哨兵集群是怎么建立连接的，主节点上有sentinel频道，哨兵会订阅这个频道，创建哨兵时会将自己的ip port发布到频道，其他哨兵节点就能连接到这个节点
2.4 哨兵每隔10秒会向主节点发送info命令，查询所有从节点信息

三、redis cluster集群
1. redis cluster集群的特点
1.1 多主多从，去中心化：所有节点都是主节点，加上一到n个从节点仅做数据备份
1.2 数据分片：集群每个节点存在slot槽存放不同数据，key会hash到对应的slot
1.3 支持动态扩容
1.4 节点间相互通信，可以自我故障检测、故障转移，不需要依靠外部的哨兵
2. redis cluster数据分片：键的crc16哈希值被称为哈希槽slot，集群共有16384个slot，每个节点会分配部分slot
2.1 添加节点，就会将其他节点的部分slot交给新增节点管理，删除节点反之；添加删除过程中集群可用的，使用redis-trib进行slot迁移，会存在slot迁移时key查询选择slot的问题
2.2 迁移过程中slot会处于一个过渡状态，迁移过程是在目标节点slot创建数据，再删除旧slot的数据；这时查询数据，会查询旧的slot，如果存在直接返回，不存在会返回客户端ack目标地址的信息，客户端接收到后先发送acking消息，保证消息会在新节点执行不会被新节点推到旧节点（因为此时还没迁移完成，向此节点的命令会move到旧节点，如果每acking会循环），然后在新节点重新执行命令
2.3 迁移过程是同步的，也就算迁移key时对应节点会阻塞，所以要避免大key，会阻塞节点上slot的操作
2.4 如果迁移过程节点网络异常，两个节点都会处于过渡状态，对数据的操作还是先查询旧节点，查询不到再ack到新节点；当重连后会继续迁移
3. 槽位迁移感知，有两个特殊的错误，move和ack
3.1 客户端都保存了节点与槽位的映射关系，当往某一节点发送操作，节点发现key的槽位不在节点，会响应move错误和目标节点，客户端就会更新映射，并往目标节点重新发送命令
3.2 ack是临时的槽位迁移感知，当slot迁移过程中，往旧节点发送操作，key不在旧节点，会响应ack和目标节点，客户端会目标节点重发命令，不会刷新映射
4. redis cluster可以自己故障检测和故障迁移
4.1 故障检测：redis每个节点都会定期ping其他节点，当节点没有pong响应，会认为该节点疑似下线，当超过半数节点ping该节点失败，会标记该节点下线并广播其他节点，进行故障转移，也就是选一个从节点为主节点
4.2 故障转移：分为三步，选择从节点为主节点，更新slot指派，广播主节点信息
4.2.1 如果只有一个从节点，就直接升级成主节点；如果没有从节点，集群会异常
4.2.2 多个从节点，就会由所有主节点进行投票，半数以上投票就成功选举成主节点，失败就计数器+1，重新选举
4.2.3 选举成功后，将下线的主节点的所有slot指派给自己；广播当前主节点信息

