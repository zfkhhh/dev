从三个方面优化tcp服务
1. 三次握手
2. 四次挥手
3. 数据传输


一、三次握手
1. 发送方syn报文的重试次数
2. 接收方半连接队列的优化
    2.1 半连接队列长度，somaxconn和sync backlog参数
    2.2 sync+ack报文重试次数
    2.3 半连接队列满了，可以开启synccookie模式，不使用半连接通过cookie建立连接
3. 全连接队列长度 min(somaxconn,backlog)
4. 全连接队列满了，有两种模式，一个是丢弃消息，一个是返RTS，如果确认半连接队列长时间满的状态，可以设置成返回RTS；正常情况还是丢弃消息，客户端会重发，当环境不恶劣队列存在空位即可立即连上
5. fast open模式，第一次连接还是正常三次握手，会创建cookie并在客户端保存,第二次连接就直接通过cookie校验，无需三次握手

二、四次挥手
1. close关闭和showdown关闭，close关闭会将四次挥手交给内核与服务端，造成孤儿连接；使用更优雅的showdown关闭再close关闭
2. wait1状态的重试次数
3. 孤儿连接无法再接收发送数据，会找出服务端不停重试，限制孤儿连接数量，当超过时，直接RTS强制关闭
4. time wait的数量，超过数量就不进入tw状态直接关闭
5. 客户端可以复用time wait状态的连接
6. 服务端close wait状态是为了继续发送数据，所有内核是没有限制close wait状态的时间，当访问close wait状态的连接过多就需要检查代码是否有问题
7. 服务端fin报文的重试次数

如果客户端服务端同时发送fin关闭会怎样？

两端同时发送fin，进入wait1状态，接收到了fin报文，进入closing状态替代wait2，再接收到ack报文，进入time wait状态，直到2msl过去，关闭连接

三、传输过程
1. 当前是tcp头有16位的滑动窗口大小，只有64k，可以在tcp option的加一个滑动窗口因子，增加到1G
2. 接收方（tcp_rmem）、发送方（tcp_wmem）缓冲区大小
3. 可以开启自动调节缓冲区大小，发送方默认是开启的，接收放开启tcp_moderate_rcvbuf
4. tcp内存范围tcp_mem可以设置内存范围3个值，当tcp内存小于第一个值是不需要自动调节，2-3之间会自动调节，大于3不在建立连接
